# Prompt maestro para Replit (Ghostwriter / AI Agent)

**Objetivo:** Construir, desde cero, una web pÃºblica con reservas online mediante calendario y un CRM interno para Costa Brava Rent a Boat Blanes, desplegada en Replit, con base de datos relacional externa y pagos.

---

## ðŸŽ¯ Rol que debes adoptar

ActÃºa como *senior fullâ€‘stack engineer* y *product designer*. Entrega cÃ³digo funcional, limpio y documentado, con foco en DX, seguridad y mantenibilidad. Responde con pasos ejecutables y explica brevemente las decisiones clave.

---

## ðŸ§± Stack solicitado (preferente)

* **Frontend**: Next.js 14 (App Router) + TypeScript + TailwindCSS + shadcn/ui.
* **Backend**: Next.js API Routes (o route handlers) con **tRPC** opcional.
* **ORM**: Prisma.
* **DB**: PostgreSQL (Neon o Supabase). **No usar** Replit DB para producciÃ³n.
* **Auth**: NextAuth (email magic link) o Clerk. Roles: `ADMIN`, `STAFF`.
* **Pagos**: Stripe (modo prueba habilitado por defecto, moneda **EUR**).
* **Email**: Resend o Nodemailer (SMTP).
* **MensajerÃ­a/WhatsApp**: Link "Click to WhatsApp" y preparar integraciÃ³n futura con WhatsApp Business Cloud API (webhook + plantillas, pero dejarlo desactivado por defecto).
* **Mapas**: Leaflet o Google Maps (marcar ubicaciÃ³n de la base en Blanes).
* **Despliegue**: Replit (servidor Node que ejecuta Next). Variables de entorno en Secrets de Replit.

> Si algo del stack no estÃ¡ disponible en Replit, propone alternativa mÃ­nima equivalente sin perder funcionalidades.

---

## ðŸï¸ Contexto del negocio

* Empresa: **Costa Brava Rent a Boat Blanes**.
* Temporada operativa: **abrilâ€“octubre** (fuera de ese rango, calendario bloqueado por defecto).
* Duraciones tÃ­picas:

  * **Barcos sin licencia**: 1h, 2h, 3h, 4h, 6h, 8h.
  * **Barcos con licencia**: 2h, 4h, 8h.
    Permitir configurar mÃ¡s franjas (desactivadas por defecto).
* EmbarcaciÃ³n destacada: **ASTEC 450** (sin licencia, hasta 5 pax, gasolina incluida). Extras disponibles: **snorkel, paddle surf, nevera, seascooter**.
* **Flota actual**:

  * **Sin licencia (5 pax)**: Astec 400, Remus 450, Solar 450, Astec 480
  * **Con licencia**: Trimarchi 57S (7 pax), Mingolla Brava 19 (6 pax), Pacificadnos Craft 625 (7 pax)
* Contacto: **Tel/WhatsApp +34611500372** Â· **Email [costabravarentboat@gmail.com](mailto:costabravarentboat@gmail.com)**.
* Idiomas: **ES (por defecto)**, **CA**, **FR**, **DE**, **NL**, **IT**, **RU**. Zona horaria: **Europe/Madrid**. Moneda: **EUR**.

---

## ðŸ” Requisitos de seguridad y legales

* RGPD: checkbox de consentimiento y enlaces a **TÃ©rminos**, **Privacidad**, **PolÃ­tica de cancelaciÃ³n**.
* Sanitizar entradas, CSRF en formularios, rateâ€‘limit en APIs sensibles, validaciÃ³n Zod.
* Logging de auditorÃ­a bÃ¡sico para operaciones crÃ­ticas del CRM.

---

## ðŸ—‚ï¸ MÃ³dulos y pÃ¡ginas

### PÃºblica

1. **Landing** (hero, valor diferencial, reseÃ±as, CTA reservar, WhatsApp).
2. **Flota** (fichas con fotos, capacidad, si requiere licencia, precios por franja, quÃ© incluye).
3. **Calendario de reservas** por embarcaciÃ³n (UX simple: seleccionar fecha â†’ franja â†’ extras â†’ resumen â†’ checkout Stripe).
4. **Contacto** (form + link WhatsApp + mapa ubicaciÃ³n).
5. **FAQ / PolÃ­ticas**.

### CRM (acceso privado)

1. **Dashboard** (hoy, prÃ³ximos 7 dÃ­as, estado de la flota, KPIs).
2. **Calendario/Agenda** (vista dÃ­a/semana/mes, por embarcaciÃ³n).
3. **Reservas**: crear/editar; estados `PENDING`, `HOLD`, `PAID`, `CANCELLED`; aplicar extras; override de disponibilidad por ADMIN.
4. **Clientes**: fichas (nombre, email, telÃ©fono, documento ID opcional, notas, histÃ³rico, consentimientos).
5. **Flota**: alta/baja de embarcaciones, mantenimiento, fotos.
6. **Extras**: catÃ¡logo con precio fijo o por franja.
7. **Informes/Export**: CSV para contabilidad y marketing.
8. **Ajustes**: franjas horarias, buffers, temporada, polÃ­tica cancelaciÃ³n, plantillas email/WhatsApp, usuarios y roles.

---

## ðŸ“¦ Modelo de datos (Prisma, orientativo)

Define Prisma schema aproximado con migraciones iniciales y seeds.

* **User**: id, name, email (unique), phone, role(`ADMIN|STAFF`), createdAt.
* **Boat**: id, name, slug, requiresLicense (bool), capacity, description, photos\[], active, baseLocation, cancellationPolicy (markdown).
* **TimeSlot**: id, label ("1h", "2h", "3h", "4h", "6h", "8h"), startTime, endTime, durationMin, bufferMin, **licenseCategory** ("NO\_LICENSE"|"LICENSED"|"ANY"), active.

  * Para `1h`, `3h`, `6h` usar `licenseCategory = NO_LICENSE`.
  * Para `2h`, `4h`, `8h` usar `licenseCategory = ANY` (vÃ¡lido para ambas clases).
* **Season**: id, code("BAJA"|"MEDIA"|"ALTA"), name, startDate, endDate, active.
* **PriceRule**: id, scope ("CLASS"|"BOAT"), class ("NO\_LICENSE"|"LICENSED")?, boatIdâ†’Boat?, seasonIdâ†’Season, timeSlotIdâ†’TimeSlot, priceEUR.
* **Extra**: id, name, description, priceEUR, unit ("flat"|"per\_slot"), active.
* **Customer**: id, firstName, lastName, email, phone, docId, notes, consentMarketing (bool), createdAt.
* **Booking**: id, code (unique), boatIdâ†’Boat, customerIdâ†’Customer, start (tz Europe/Madrid), end, status, totalEUR, stripePaymentIntentId, notes.
* **BookingExtra**: bookingIdâ†’Booking, extraIdâ†’Extra, quantity, priceEUR.
* **BlockedRange**: id, boatIdâ†’Boat, start, end, reason.
* **AuditLog**: id, userIdâ†’User, action, entity, entityId, meta(json), at.

> Semillas: crear la flota inicial con sus `Boat` y fotos de ejemplo:
>
> * **Sin licencia (5 pax)**: Astec 400, Remus 450, Solar 450, Astec 480
> * **Con licencia**: Trimarchi 57S (7 pax), Mingolla Brava 19 (6 pax), Pacificadnos Craft 625 (7 pax)
>   ademÃ¡s de la embarcaciÃ³n destacada **ASTEC 450** (sin licencia, 5 pax).
>   AÃ±adir los extras citados y las franjas:
> * **Sin licencia**: 1h, 2h, 3h, 4h, 6h, 8h
> * **Con licencia**: 2h, 4h, 8h
>   con `bufferMin=30`.
>   **Tarifas (sin licencia, todas salvo Astec 480)**
> * **Temporada BAJA (1/4â€“30/6 y 1/9â€“cierre)**: 1h 75â‚¬, 2h 115â‚¬, 3h 130â‚¬, 4h 150â‚¬, 6h 190â‚¬, 8h 220â‚¬
> * **Temporada MEDIA (1/7â€“31/7)**: 1h 85â‚¬, 2h 130â‚¬, 3h 160â‚¬, 4h 180â‚¬, 6h 230â‚¬, 8h 270â‚¬
> * **Temporada ALTA (1/8â€“31/8)**: 1h 95â‚¬, 2h 140â‚¬, 3h 170â‚¬, 4h 195â‚¬, 6h 240â‚¬, 8h 290â‚¬
>   **Astec 480** (override):
> * **BAJA**: 1h 80â‚¬, 2h 130â‚¬, 3h 155â‚¬, 4h 180â‚¬, 6h 230â‚¬, 8h 270â‚¬
> * **MEDIA**: 1h 90â‚¬, 2h 150â‚¬, 3h 190â‚¬, 4h 220â‚¬, 6h 270â‚¬, 8h 310â‚¬
> * **ALTA**: 1h 100â‚¬, 2h 170â‚¬, 3h 200â‚¬, 4h 230â‚¬, 6h 290â‚¬, 8h 340â‚¬
>   **Con licencia** (2h/4h/8h):
> * **BAJA**: 2h 160â‚¬, 4h 240â‚¬, 8h 290â‚¬
> * **MEDIA**: 2h 180â‚¬, 4h 260â‚¬, 8h 340â‚¬
> * **ALTA**: 2h 200â‚¬, 4h 280â‚¬, 8h 390â‚¬

## ðŸ§® LÃ³gica de disponibilidad

* Una franja es **reservable** si: no hay *Booking* que se solape **incluyendo buffer** y no cae dentro de *BlockedRange* ni fuera de temporada.
* Al iniciar checkout, crear **hold** temporal (estado `HOLD`) que caduca a los **15 min** si no se paga. Eliminar hold al cancelar o al expirar.
* Prevenir **doble reserva** con transacciÃ³n atÃ³mica.
* ADMIN puede crear reservas **sin pago** o marcarlas como `PAID` manualmente.
* Las franjas disponibles respetan la categorÃ­a del barco: **sin licencia** â†’ 1h/2h/3h/4h/6h/8h; **con licencia** â†’ 2h/4h/8h.

---

## ðŸ’³ Pagos & precios

### Estructura de tarifas

* Temporadas: **BAJA** (1 abrilâ€“30 junio y 1 septiembreâ€“cierre), **MEDIA** (1â€“31 julio), **ALTA** (1â€“31 agosto).
* Usar **PriceRule** por temporada con *fallback* por **clase** (NO\_LICENSE / LICENSED) y *override* por **barco** (ej. Astec 480).

### Clase **NO\_LICENSE** (sin licencia, **todas salvo Astec 480**)

* **BAJA** â†’ 1h **75â‚¬**, 2h **115â‚¬**, 3h **130â‚¬**, 4h **150â‚¬**, 6h **190â‚¬**, 8h **220â‚¬**
* **MEDIA** â†’ 1h **85â‚¬**, 2h **130â‚¬**, 3h **160â‚¬**, 4h **180â‚¬**, 6h **230â‚¬**, 8h **270â‚¬**
* **ALTA** â†’ 1h **95â‚¬**, 2h **140â‚¬**, 3h **170â‚¬**, 4h **195â‚¬**, 6h **240â‚¬**, 8h **290â‚¬**

### **Astec 480** (override por barco)

* **BAJA (1/4â€“30/6 y 1/9â€“cierre)** â†’ 1h **80â‚¬**, 2h **130â‚¬**, 3h **155â‚¬**, 4h **180â‚¬**, 6h **230â‚¬**, 8h **270â‚¬**
* **MEDIA (1/7â€“31/7)** â†’ 1h **90â‚¬**, 2h **150â‚¬**, 3h **190â‚¬**, 4h **220â‚¬**, 6h **270â‚¬**, 8h **310â‚¬**
* **ALTA (1/8â€“31/8)** â†’ 1h **100â‚¬**, 2h **170â‚¬**, 3h **200â‚¬**, 4h **230â‚¬**, 6h **290â‚¬**, 8h **340â‚¬**

### Clase **LICENSED** (con licencia: Trimarchi 57S, Mingolla Brava 19, Pacificadnos Craft 625)

* **BAJA** â†’ 2h **160â‚¬**, 4h **240â‚¬**, 8h **290â‚¬**

* **MEDIA** â†’ 2h **180â‚¬**, 4h **260â‚¬**, 8h **340â‚¬**

* **ALTA** â†’ 2h **200â‚¬**, 4h **280â‚¬**, 8h **390â‚¬**

* Mostrar desglose: precio base franja + extras + impuestos (si aplica) + depÃ³sitos (si se usan, simular con Stripe PaymentIntent capture/confirm segÃºn configuraciÃ³n).

* Precios por embarcaciÃ³n y franja. Usar **PriceRule** por temporada (BAJA, MEDIA, ALTA) con *fallback* por **clase** y *override* por **barco** (ej. Astec 480).

* Guardar `stripePaymentIntentId` y webhooks `/api/webhooks/stripe`.

## ðŸ”” Notificaciones

* Email al cliente (confirmaciÃ³n con ics adjunto) y a `costabravarentboat@gmail.com`.
* Enlace directo **WhatsApp** pre-relleno con datos de la reserva para comunicaciÃ³n rÃ¡pida (sin API, por ahora).

---

## ðŸŒ i18n

* next-intl o i18next. Empezar con **ES** y preparar plantillas para **CA, FR, DE, NL, IT, RU**. Formatos de fecha/hora en **Europe/Madrid**.

---

## ðŸ–¥ï¸ UX/UI

* DiseÃ±o limpio, marino, accesible (WCAG AA), responsive.
* Calendario claro: selecciÃ³n de barco â†’ fecha â†’ franja â†’ extras â†’ checkout.
* En admin, vista tipo kanban/lista + calendario.

---

## ðŸ”§ Comandos & estructura

* Scripts: `dev`, `build`, `start`, `prisma migrate dev`, `prisma db seed`.
* `.env.example` con claves: DATABASE\_URL, NEXTAUTH\_SECRET, NEXTAUTH\_URL, STRIPE\_SECRET\_KEY, STRIPE\_WEBHOOK\_SECRET, RESEND\_API\_KEY, SITE\_URL, DEFAULT\_LOCALE, BUSINESS\_PHONE.
* DocumentaciÃ³n `README.md` con pasos para Replit (aÃ±adir secrets, ejecutar migraciones y seed, arrancar).

---

## ðŸ”— Endpoints/API (ejemplos)

* `GET /api/boats` (list), `GET /api/boats/:slug` (detail)
* `POST /api/availability` { boatId, date } â†’ franjas libres
* `POST /api/bookings` (crear hold) â†’ { bookingId, clientSecret }
* `POST /api/bookings/:id/confirm` (confirmar pago Stripe webhook)
* `POST /api/bookings/:id/cancel`
* `POST /api/webhooks/stripe`
* CRUD autenticado para **boats, extras, seasons, timeslots, blockedRanges, customers, bookings** (solo ADMIN/STAFF).

---

## âœ… Criterios de aceptaciÃ³n

1. Puedo seleccionar un barco **sin licencia** estÃ¡ndar (no Astec 480) en una fecha de **julio** y ver franjas **1h/2h/3h/4h/6h/8h** con precios correctos de **temporada MEDIA** (p. ej., **1h = 85â‚¬**, **4h = 180â‚¬**), completar pago Stripe (modo test) sin doble reserva.
2. En **agosto**, un barco sin licencia estÃ¡ndar muestra **4h = 195â‚¬** y **8h = 290â‚¬** (temporada ALTA). Para **Astec 480**, en **agosto**, **4h = 230â‚¬** (override por barco).
3. Puedo seleccionar **Trimarchi 57S** (con licencia), ver solo **2h/4h/8h** y que en **julio** **4h = 260â‚¬** y **8h = 340â‚¬**. Crear desde el CRM una reserva de **4h** y marcarla manualmente `PAID`.
4. Recibo email de confirmaciÃ³n con archivo `.ics` y link de WhatsApp pre-relleno.
5. En el CRM, veo el calendario semanal por embarcaciÃ³n y puedo crear una reserva manual sin pago.
6. Export CSV de reservas del mes.
7. La app arranca en Replit con variables de entorno y seed funcionando.

---

## ðŸ› ï¸ Tareas paso a paso que debes ejecutar

1. Inicializa proyecto Next.js + Tailwind + shadcn/ui + Prisma.
2. Configura PostgreSQL (Neon/Supabase) y aÃ±ade `DATABASE_URL` en Replit Secrets.
3. Crea el **schema.prisma** y `prisma db push`; luego **seed** con ASTEC 450, extras y franjas.
4. Implementa auth con roles y protectores de ruta (middleware).
5. Implementa API de disponibilidad con transacciones y buffer.
6. Implementa flujo de checkout Stripe (hold + confirmaciÃ³n por webhook).
7. Construye el calendario pÃºblico y las vistas del CRM.
8. AÃ±ade i18n (ES listo, CA/EN marcado TODO) y polÃ­ticas legales.
9. Emails de confirmaciÃ³n + archivo ICS (calEvent) y links de WhatsApp.
10. README con instrucciones especÃ­ficas de Replit.

---

## ðŸ“„ Copia de ejemplo para la web (ES)

* **Hero**: "Alquila tu barco en Blanes. Sin licencia. FÃ¡cil, seguro y con gasolina incluida."
* **CTA**: "Reservar ahora" / "Hablar por WhatsApp".
* **ASTEC 450**: "Hasta 5 personas, solÃ¡rium, toldo, escalera de baÃ±o. Opciones: snorkel, paddle surf, nevera, seascooter."

---

## ðŸ§ª Datos de prueba

* Cliente: Ana GarcÃ­a, [ana@example.com](mailto:ana@example.com), +34 600 000 000.
* Reserva: 12 de julio, 10:00â€“14:00, ASTEC 450, extras: paddle surf + nevera.

---

## ðŸ“Ž Notas

* Usa Zod para validar payloads.
* Considera *soft deletes* (campo `deletedAt`) para registros crÃ­ticos.
* Escribe tests bÃ¡sicos para la lÃ³gica de solapes y hold.
* Optimiza imÃ¡genes (next/image).

> **Entrega**: repositorio funcional con instrucciones claras y todo lo necesario para ejecutar en Replit sin pasos manuales ocultos.
